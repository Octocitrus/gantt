<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="elements/gantt-step.html">
<link rel="import" href="elements/svg-arrow.html">

<dom-module id="gantt-widget">

	<template strip-whitespace>
		<style>

			:host {
				display: block;
				height: [[height]];
				width: [[width]];
				background: #fff;
				overflow: hidden;

				--grid-line-color: #eee;

				--no-user-select: {
					-webkit-user-select: none;
					-khtml-user-select: none;
					-moz-user-select: none;
					-ms-user-select: none;
					user-select: none;
  			}

				--gantt-bg-grid: {
					background: var(--grid-line-color);
					/* Webkit (Safari/Chrome 10) */
					background: -webkit-gradient(linear, left top, right top, color-stop(1px, var(--grid-line-color)), color-stop(0, transparent)), -webkit-gradient(linear, left top, left bottom, color-stop(1px, var(--grid-line-color)), color-stop(0, transparent));
					/* Webkit (Chrome 11+) */
					background: -webkit-linear-gradient(var(--grid-line-color) 1px, transparent 0px), -webkit-linear-gradient(0deg, var(--grid-line-color) 1px, transparent 0px);
					/* Mozilla Firefox */
					background: -moz-linear-gradient(var(--grid-line-color) 1px, transparent 0px), -moz-linear-gradient(0deg, var(--grid-line-color) 1px, transparent 0px);
					/* IE10 Consumer Preview */
					background: -ms-linear-gradient(0deg, var(--grid-line-color) 1.1px, transparent 0px), -ms-linear-gradient(90deg, var(--grid-line-color) 1.1px, transparent 0px);
					/* Opera */
					background: -o-linear-gradient(var(--grid-line-color) 1px, transparent 0px), -o-linear-gradient(90deg, var(--grid-line-color) 1px, transparent 0px);
					/* W3C Markup, IE10 Release Preview */
					background: linear-gradient(0deg, var(--grid-line-color) 1px, transparent 0px), linear-gradient(90deg, var(--grid-line-color) 1.1px, transparent 0px);

					background-attachment: local;
				}
			}

			.timeline {
				overflow: hidden;
				position: relative;
			}

			.year,
			.month,
			.day {
				padding-left: 2px;
				text-overflow: ellipsis;
				white-space: nowrap;
		   	border-right: 1px solid #A9A9A9;
		    background-color: #d0d0d0;
		    box-sizing: border-box;
		    -moz-box-sizing: border-box;
		    -webkit-box-sizing: border-box;

			    &.spacer {
			    	padding-left: 0px;
			    }
			}
			.year.spacer,
			.month.spacer,
			.day.spacer {
				padding-left: 0px;
			}

			.month:nth-of-type(even),
			.day:nth-of-type(even) {
			    background-color: #ddd;
			}
			.col.even {
			    background-color: #ccc;
			}

			.col {
				position: [[colPosition]];
				left: [[colLeft]]px;
				height: 100%;
				float: left;
				overflow: hidden;
				border-right: 1px solid #A9A9A9;
				background-color: #ddd;
				font-size: 10px;
				text-align: center;
				box-sizing: border-box;
				-moz-box-sizing: border-box;
				-webkit-box-sizing: border-box;
				-webkit-touch-callout: none;
				@apply --no-user-select;
			}

			.c-col {
				width: [[colCenterWidth]];
			}

			.f-col {
				width: [[colFirstWidth]];
			}

			.l-col {
				width: [[colLastWidth]];
			}

			.col.w {
				text-align: left;
			}

			.col.weekend {
				background-color: #ccc;
			}

			.col.measure {
			    // Change min-width to adjust grid's cell width with day and hour-resolution.
				//min-width: 40px;
			}
			.col.w.measure {
				// Change min-width to adjust grid's cell width with week-resolution.
				//min-width: 70px;
			}

			.row {
				width: 100%;
				float: left;
				overflow: hidden;
				height: 15px;
				-ms-flex-pack: justify;
				-webkit-touch-callout: none;
				@apply --no-user-select;
			}
			.gantt-container {
				width: 100%;
				height: 100%;
				overflow: auto;
				@apply --no-user-select;
				@apply --gantt-bg-grid;
			}

			.gantt-content {
				background: transparent;
				overflow: hidden;
				position: relative;
				width:	100%;
				height: 100%;
			}

			.mv-el {
				position: absolute;
				top: 0;
				box-sizing: border-box;
				-moz-box-sizing: border-box;
				-webkit-box-sizing: border-box;
				height: 100%;
				z-index: 2;
				background: transparent;
				border-left: 1px dashed #ddd;
				border-right: 1px dashed #ddd;
			}

			/* Optional background svg element. */
			svg.bg-grid {
				position: absolute;
				overflow: hidden;
				top: 0;
				z-index: 0;
				background: transparent;
			}

		</style>

				<!-- >div class="timeline"></div-->
			<div id="ganttContainer" class="gantt-container" on-scroll="handleContainerScroll">
				<div id="ganttContent" class="gantt-content">
					<div class="mv-el" style="display: none;"></div>

					<template is="dom-repeat" items="{{steps}}" as="step">
			      <gantt-step step="{{step}}"
							caption="{{step.caption}}"
							description="{{step.description}}"
							show-progress="{{step.showProgress}}"
							style-name="{{step.styleName}}"
							background-color="{{step.backgroundColor}}"
							progress="{{step.progress}}"
							resizable="{{step.resizable}}"
							movable="{{step.movable}}"
							start-date="{{step.startDate}}"
							end-date="{{step.endDate}}">
						</gantt-step>
			    </template>

				</div>
			</div>
			<div style="display: none;"></div>

	</template>

	<script>
		class GanttWidget extends Polymer.Element {
			static get is() { return 'gantt-widget'; }

			static get properties() {
				return {
						ganttElement: Object,
						height: String,
						width: String,
						colLeft: {
							type: Number,
							value: 0,
						},
						colPosition: {
							type: String,
							value: "static",
						},
						colCenterWidth: {
							type: String,
							value: "auto",
						},
						colFirstWidth: {
							type: String,
							value: "auto",
						},
						colLastWidth: {
							type: String,
							value: "auto",
						},
						steps: {
							type: Array,
						},
				};
			}

			constructor() {
				super();
			}

			connectedCallback() {
				super.connectedCallback();
				if(!this.readyAndConnected) {
					this.addEventListener('register-step', e => this._onRegisterStep(e));
				}
				this.readyAndConnected = true;
			}

			static get observers() {
			  return [
			    'stepsAddedOrRemoved(steps.splices)'
			  ]
			}

			stepsAddedOrRemoved(changeRecord) {
				if (this.ganttElement && changeRecord) {
		      changeRecord.indexSplices.forEach(function(s) {
		        s.removed.forEach(function(step) {
		          console.log(step.caption + ' was removed');

		        });
		        for (var i=0; i<s.addedCount; i++) {
		          var index = s.index + i;
		          var newStep = s.object[index];
		          console.log('Step ' + newStep.caption + ' added at index ' + index);
		        }
		      }, this);
		    }
			}

			_onRegisterStep(event) {
				event.detail.stepElement.ganttElement = this.ganttElement;
				if(this.ganttElement && event.detail.step && !event.detail.step.substep) {
					console.log('Registering Step ' + event.detail.step.uid);
					this.ganttElement.registerStepElement(event.detail.stepElement, event.detail.step);
				}
			}

			registerContainerScrollHandler(f) {
				this.containerScrollHandler = f;
			}
			handleContainerScroll(e) {
				if(this.containerScrollHandler) {
					this.containerScrollHandler(e);
				}
			}

			handleStepClicked(stepUid, details) {
			}
			handleOnMove(newStepUid, startDate, endDate, details) {
			}
			handleOnResize(stepUid, startDate, endDate, details) {
			}
			handleOnPredecessorChange(newPredecessorStepUid, forTargetStepUid, clearPredecessorForStepUid) {
			}
		}
		customElements.define(GanttWidget.is, GanttWidget);
	</script>

</dom-module>
